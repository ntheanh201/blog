<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Phoenix: Ecto cheatsheet</title>
  <link href="s/main.css" rel="stylesheet" />
  <script src="s/main.js"></script>
</head>

<body onload="start()">
  <div class="breadcrumbs"><a href="/">Home</a> / <a href="index.html">cheatsheets</a> / Phoenix: Ecto cheatsheet</div>
  <div class="edit">
      <a href="https://github.com/kjk/blog/blob/master/www/cheatsheets/devhints/phoenix-ecto.md" >edit</a>
  </div>
  <div class="toc">
<b>Schemas</b>: <a href="#generating">Generating</a>, <a href="#schema">Schema</a>, <a href="#field-types">Field types</a><br>
<b>Changesets</b>: <a href="#changesets1">Changesets</a>, <a href="#changeset-fields">Changeset fields</a>, <a href="#updating">Updating</a>, <a href="#getting">Getting</a><br>
<b>Repo</b>: <a href="#get-one">Get one</a>, <a href="#create-update">Create/update</a><br>
<b>Many</b>: <a href="#queries">Queries</a>, <a href="#get-many">Get many</a>, <a href="#update-many">Update many</a>, <a href="#chaining-_all-with-queries">Chaining _all with queries</a><br>
<a href="#references">References</a><br></div>


  <div id="start"></div>
  <div id="wrapped-content"></div>
<div id="content">
<h2 id="schemas">Schemas</h2>
<h3 id="generating">Generating</h3>

<pre><code class="bash">$ mix phx.gen.html \
    Accounts \       <span class="hljs-comment"># domain</span>
    Profile \        <span class="hljs-comment"># schema</span>
    profiles \       <span class="hljs-comment"># table name</span>
    email:string \
    age:<span class="hljs-built_in">integer</span>
</code></pre>
<h3 id="schema">Schema</h3>

<pre><code class="elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">Myapp.Accounts.User</span></span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">use</span> Ecto.Schema

  schema <span class="hljs-string">&quot;users&quot;</span> <span class="hljs-keyword">do</span>
    field <span class="hljs-symbol">:name</span>
    field <span class="hljs-symbol">:age</span>, <span class="hljs-symbol">:integer</span>
    field <span class="hljs-symbol">:password</span>, <span class="hljs-symbol">virtual:</span> <span class="hljs-keyword">true</span>

    timestamps()
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="field-types">Field types</h3>

<table>
<thead>
<tr>
<th>Field</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>:id</code></td>
</tr>
<tr>
<td><code>:binary</code></td>
</tr>
<tr>
<td><code>:boolean</code></td>
</tr>
<tr>
<td><code>:string</code></td>
</tr>
<tr>
<td>---</td>
</tr>
<tr>
<td><code>:integer</code></td>
</tr>
<tr>
<td><code>:float</code></td>
</tr>
<tr>
<td><code>:decimal</code></td>
</tr>
<tr>
<td>---</td>
</tr>
<tr>
<td>``</td>
</tr>
<tr>
<td><code>:map</code></td>
</tr>
</tbody>
</table>
<h2 id="changesets">Changesets</h2>
<h3 id="changesets1">Changesets</h3>

<pre><code class="elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">changeset</span></span>(user, params \\ <span class="hljs-symbol">:empty</span>) <span class="hljs-keyword">do</span>
  %User{}
  |&gt; Ecto.Changeset.change   <span class="hljs-comment"># basic casting to changeset</span>

  user
  |&gt; cast(params, <span class="hljs-string">~w(name email)</span>, <span class="hljs-string">~w(age)</span>) <span class="hljs-comment"># params to Changeset</span>

  |&gt; validate_format(<span class="hljs-symbol">:email</span>, <span class="hljs-string">~r/@/</span>)

  |&gt; validate_inclusion(<span class="hljs-symbol">:age</span>, <span class="hljs-number">18</span>..<span class="hljs-number">100</span>)
  |&gt; validate_exclusion(<span class="hljs-symbol">:role</span>, <span class="hljs-string">~w(admin superadmin)</span>)
  |&gt; validate_subset(<span class="hljs-symbol">:pets</span>, <span class="hljs-string">~w(cat dog parrot whale)</span>)

  |&gt; validate_length(<span class="hljs-symbol">:body</span>, <span class="hljs-symbol">min:</span> <span class="hljs-number">1</span>)
  |&gt; validate_length(<span class="hljs-symbol">:body</span>, <span class="hljs-symbol">min:</span> <span class="hljs-number">1</span>, <span class="hljs-symbol">max:</span> <span class="hljs-number">160</span>)
  |&gt; validate_length(<span class="hljs-symbol">:partners</span>, <span class="hljs-symbol">is:</span> <span class="hljs-number">2</span>)

  |&gt; validate_number(<span class="hljs-symbol">:pi</span>, <span class="hljs-symbol">greater_than:</span> <span class="hljs-number">3</span>)
  |&gt; validate_number(<span class="hljs-symbol">:pi</span>, <span class="hljs-symbol">less_than:</span> <span class="hljs-number">4</span>)
  |&gt; validate_number(<span class="hljs-symbol">:pi</span>, <span class="hljs-symbol">equal_to:</span> <span class="hljs-number">42</span>)

  |&gt; validate_change(<span class="hljs-symbol">:title</span>, <span class="hljs-keyword">fn</span> _, _ -&gt; [])
  |&gt; validate_confirmation(<span class="hljs-symbol">:password</span>, <span class="hljs-symbol">message:</span> <span class="hljs-string">&quot;does not match&quot;</span>)

  |&gt; unique_constraint(<span class="hljs-symbol">:email</span>)
  |&gt; foreign_key_constraint(<span class="hljs-symbol">:post_id</span>)
  |&gt; assoc_constraint(<span class="hljs-symbol">:post</span>)      <span class="hljs-comment"># ensure post_id exists</span>
  |&gt; no_assoc_constraint(<span class="hljs-symbol">:post</span>)   <span class="hljs-comment"># negative (useful for deletions)</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="changeset-fields">Changeset fields</h3>

<pre><code class="elixir">changeset.valid?
changeset.errors     <span class="hljs-comment">#=&gt; [title: &quot;empty&quot;]</span>

changeset.changes    <span class="hljs-comment">#=&gt; %{}</span>
changeset.params[<span class="hljs-symbol">:title</span>]

changeset.required   <span class="hljs-comment">#=&gt; [:title]</span>
changeset.optional   <span class="hljs-comment">#=&gt; [:body]</span>
</code></pre>
<h3 id="updating">Updating</h3>

<pre><code class="elixir">changeset <span class="hljs-comment">#(or model)</span>
|&gt; change(<span class="hljs-symbol">title:</span> <span class="hljs-string">&quot;New title&quot;</span>)
|&gt; change(%{ <span class="hljs-symbol">title:</span> <span class="hljs-string">&quot;New title&quot;</span> })
|&gt; put_change(<span class="hljs-symbol">:title</span>, <span class="hljs-string">&quot;New title&quot;</span>)
|&gt; force_change(<span class="hljs-symbol">:title</span>, <span class="hljs-string">&quot;New title&quot;</span>)
|&gt; update_change(<span class="hljs-symbol">:title</span>, &amp;(&amp;<span class="hljs-number">1</span> &lt;&gt; <span class="hljs-string">&quot;...&quot;</span>))

|&gt; delete_change(<span class="hljs-symbol">:title</span>)
|&gt; merge(other_changeset)

|&gt; add_error(<span class="hljs-symbol">:title</span>, <span class="hljs-string">&quot;empty&quot;</span>)
</code></pre>
<h3 id="getting">Getting</h3>

<pre><code class="elixir">get_change(changeset, <span class="hljs-symbol">:title</span>)    <span class="hljs-comment">#=&gt; &quot;hi&quot; (if changed)</span>
get_field(changeset, <span class="hljs-symbol">:title</span>)     <span class="hljs-comment">#=&gt; &quot;hi&quot; (even if unchanged)</span>

fetch_change(changeset, <span class="hljs-symbol">:title</span>)  <span class="hljs-comment">#=&gt;  | :error</span>
fetch_field(changeset, <span class="hljs-symbol">:title</span>)   <span class="hljs-comment">#=&gt;  | :error</span>
</code></pre>
<h2 id="repo">Repo</h2>
<h3 id="get-one">Get one</h3>

<pre><code class="elixir">Repo.get(User, id)
Repo.get_by(User, <span class="hljs-symbol">email:</span> <span class="hljs-string">&quot;john@hello.com&quot;</span>)  <span class="hljs-comment">#=&gt; %User{} | nil</span>

<span class="hljs-comment"># also get! get_by!</span>
</code></pre>
<h3 id="create-update">Create/update</h3>

<pre><code class="elixir">changeset |&gt; Repo.update
changeset |&gt; Repo.insert
changeset |&gt; Repo.insert_or_update
</code></pre>

<pre><code>User
|<span class="hljs-type">&gt; Ecto</span>.Changeset.<span class="hljs-built_in">change</span>(%{name: <span class="hljs-string">&quot;hi&quot;</span>})
|<span class="hljs-type">&gt; Repo</span>.insert
</code></pre>
<h2 id="many">Many</h2>
<h3 id="queries">Queries</h3>

<pre><code class="elixir">from p <span class="hljs-keyword">in</span> Post,
  <span class="hljs-symbol">where:</span> p.title == <span class="hljs-string">&quot;Hello&quot;</span>,
  <span class="hljs-symbol">where:</span> [<span class="hljs-symbol">state:</span> <span class="hljs-string">&quot;Sweden&quot;</span>],

  <span class="hljs-symbol">limit:</span> <span class="hljs-number">1</span>,
  <span class="hljs-symbol">offset:</span> <span class="hljs-number">10</span>,

  <span class="hljs-symbol">order_by:</span> c.name,
  <span class="hljs-symbol">order_by:</span> [c.name, c.title],
  <span class="hljs-symbol">order_by:</span> [<span class="hljs-symbol">asc:</span> c.name, <span class="hljs-symbol">desc:</span> c.title],

  <span class="hljs-symbol">preload:</span> [<span class="hljs-symbol">:comments</span>],
  <span class="hljs-symbol">preload:</span> [<span class="hljs-symbol">comments:</span> {c, <span class="hljs-symbol">likes:</span> l}],

  <span class="hljs-symbol">join:</span> c <span class="hljs-keyword">in</span> assoc(c, <span class="hljs-symbol">:comments</span>),
  <span class="hljs-symbol">join:</span> p <span class="hljs-keyword">in</span> Post, <span class="hljs-symbol">on:</span> c.post_id == p.id,
  <span class="hljs-symbol">group_by:</span> p,

  <span class="hljs-symbol">select:</span> p,
  <span class="hljs-symbol">select:</span> {p.title, p.description},
  <span class="hljs-symbol">select:</span> [p.title, p.description],
</code></pre>
<h3 id="get-many">Get many</h3>

<pre><code class="elixir">Repo.all(User)
</code></pre>
<h3 id="update-many">Update many</h3>

<pre><code class="elixir">Repo.update_all(Post, <span class="hljs-symbol">set:</span> [<span class="hljs-symbol">title:</span> <span class="hljs-string">&quot;Title&quot;</span>])
Repo.update_all(Post, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">views:</span> <span class="hljs-number">1</span>])
</code></pre>
<h3 id="chaining-_all-with-queries">Chaining <code>_all</code> with queries</h3>

<pre><code class="elixir">from(p <span class="hljs-keyword">in</span> Post, <span class="hljs-symbol">where:</span> p.id &lt; <span class="hljs-number">10</span>)
|&gt; Repo.update_all(...)

from(p <span class="hljs-keyword">in</span> Post, <span class="hljs-symbol">where:</span> p.id &lt; <span class="hljs-number">10</span>)
|&gt; Repo.all()
</code></pre>
<h2 id="references">References</h2>

<ul>
<li>Based on Ecto 1.3.</li>
</ul>

</div>
</body>  
</html>