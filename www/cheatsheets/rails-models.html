<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rails models cheatsheet</title>
  <link href="s/main.css" rel="stylesheet" />
  <script src="s/main.js"></script>
</head>

<body onload="start()">
  <div class="breadcrumbs"><a href="/">Home</a> / <a href="index.html">cheatsheets</a> / Rails models cheatsheet</div>
  <div class="edit">
      <a href="https://github.com/kjk/blog/blob/master/www/cheatsheets/devhints\rails-models.md" >edit</a>
  </div>
  <div class="toc">
<b>Generating</b>: <a href="#generating1">Generating</a><br>
<b>Using models</b>: <a href="#query-methods">Query methods</a>, <a href="#advanced-query-methods">Advanced query methods</a>, <a href="#finder-methods">Finder methods</a>, <a href="#persistence">Persistence</a>, <a href="#attribute-assignment">Attribute Assignment</a>, <a href="#dirty">Dirty</a>, <a href="#validations">Validations</a>, <a href="#calculations">Calculations</a>, <a href="#dynamic-attribute-based-finders">Dynamic attribute-based finders</a><br>
<b>Associations</b>: <a href="#associations1">Associations</a>, <a href="#has-many">Has many</a>, <a href="#belongs-to">belongs to</a>, <a href="#many-to-many">Many-to-many</a>, <a href="#many-to-many-habtm-">Many-to-many (HABTM)</a>, <a href="#polymorphic-associations">Polymorphic associations</a><br>
<b>Validation</b>: <a href="#validation1">Validation</a>, <a href="#custom-validations">Custom validations</a>, <a href="#errors">Errors</a><br>
<b>Other API</b>: <a href="#callbacks">Callbacks</a>, <a href="#mass-updates">Mass updates</a>, <a href="#joining">Joining</a>, <a href="#where-interpolation">Where interpolation</a>, <a href="#serialize">Serialize</a><br>
<b>Other tricks</b>: <a href="#overriding-accessors">Overriding accessors</a><br>
<a href="#callbacks1">Callbacks</a><br></div>


  <div id="start"></div>
  <div id="wrapped-content"></div>
<div id="content">
<h2 id="generating">Generating</h2>
<h3 id="generating1">Generating</h3>

<pre><code><span class="hljs-symbol">$</span> rails g <span class="hljs-keyword">model</span> User
</code></pre>
<h2 id="using-models">Using models</h2>
<h3 id="query-methods">Query methods</h3>

<pre><code class="ruby">items = Model
  .where(<span class="hljs-symbol">first_name:</span> <span class="hljs-string">&#x27;Harvey&#x27;</span>)
  .where(<span class="hljs-string">&#x27;id = 3&#x27;</span>)
  .where(<span class="hljs-string">&#x27;id = ?&#x27;</span>, <span class="hljs-number">3</span>)
</code></pre>

<pre><code class="ruby">  .order(<span class="hljs-symbol">:title</span>)
  .order(<span class="hljs-symbol">title:</span> <span class="hljs-symbol">:desc</span>)
  .order(<span class="hljs-string">&quot;title DESC&quot;</span>)
</code></pre>

<pre><code class="ruby">  .reorder(<span class="hljs-symbol">:title</span>)  <span class="hljs-comment"># discards other .order&#x27;s</span>
  .rewhere(...)     <span class="hljs-comment"># discards other .where&#x27;s</span>
</code></pre>

<pre><code class="ruby">  .limit(<span class="hljs-number">2</span>)
  .offset(<span class="hljs-number">1</span>)
  .uniq
</code></pre>
<p>See: <a href="http://devdocs.io/rails/activerecord/querymethods">QueryMethods</a></p>
<h3 id="advanced-query-methods">Advanced query methods</h3>

<pre><code class="ruby">items = Model
  .select(<span class="hljs-symbol">:id</span>)
  .select([<span class="hljs-symbol">:id</span>, <span class="hljs-symbol">:name</span>])
</code></pre>

<pre><code class="ruby">  .group(<span class="hljs-symbol">:name</span>)   <span class="hljs-comment"># GROUP BY name</span>
  .group(<span class="hljs-string">&#x27;name AS grouped_name, age&#x27;</span>)
  .having(<span class="hljs-string">&#x27;SUM(price) &gt; 30&#x27;</span>)  <span class="hljs-comment"># needs to be chained with .group</span>
</code></pre>

<pre><code class="ruby">  .includes(<span class="hljs-symbol">:user</span>)
  .includes(<span class="hljs-symbol">user:</span> [<span class="hljs-symbol">:articles</span>])
</code></pre>

<pre><code class="ruby">  .references(<span class="hljs-symbol">:posts</span>)
  <span class="hljs-comment"># aka: .where(&quot;posts.name = &#x27;foo&#x27;&quot;).references(:posts)</span>
</code></pre>
<h3 id="finder-methods">Finder methods</h3>

<pre><code class="ruby">item = Model.find(id)
item = Model.find_by_email(email)
item = Model.where(<span class="hljs-symbol">email:</span> email).first
</code></pre>

<pre><code class="ruby">Model
  .exists?(<span class="hljs-number">5</span>)
  .exists?(<span class="hljs-symbol">name:</span> <span class="hljs-string">&quot;David&quot;</span>)
</code></pre>

<pre><code class="ruby">  .first
  .last
  .find_nth(<span class="hljs-number">4</span>, [offset])
</code></pre>
<p>See: <a href="http://devdocs.io/rails/activerecord/findermethods">FinderMethods</a></p>
<h3 id="persistence">Persistence</h3>

<pre><code class="ruby">item.new_record?
item.persisted?
item.destroyed?

item.serialize_hash
</code></pre>

<pre><code class="ruby">item.save
item.save!      <span class="hljs-comment"># Same as above, but raises an Exception</span>
</code></pre>

<pre><code class="ruby">item.update  <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;John&#x27;</span>  <span class="hljs-comment"># Saves immediately</span>
item.update! <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;John&#x27;</span>
</code></pre>

<pre><code class="ruby">item.update_column  <span class="hljs-symbol">:name</span>, <span class="hljs-string">&#x27;John&#x27;</span>  <span class="hljs-comment"># skips validations and callbacks</span>
item.update_columns  <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;John&#x27;</span>
item.update_columns! <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;John&#x27;</span>
</code></pre>

<pre><code class="ruby">item.touch                 <span class="hljs-comment"># updates :updated_at</span>
item.touch <span class="hljs-symbol">:published_at</span>
</code></pre>

<pre><code class="ruby">item.destroy
item.delete  <span class="hljs-comment"># skips callbacks</span>
</code></pre>

<pre><code class="ruby">Model.create     <span class="hljs-comment"># Same an #new then #save</span>
Model.create!    <span class="hljs-comment"># Same as above, but raises an Exception</span>
</code></pre>
<p>See: <a href="http://devdocs.io/rails/activerecord/persistence">Persistence</a></p>
<h3 id="attribute-assignment">Attribute Assignment</h3>

<pre><code class="ruby">item.attributes                      <span class="hljs-comment"># #&lt;Hash&gt;</span>
</code></pre>

<pre><code class="ruby">item.attributes = { <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;John&#x27;</span> }   <span class="hljs-comment"># Merges attributes in. Doesn&#x27;t save.</span>
item.assign_attributes <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;John&#x27;</span>  <span class="hljs-comment"># Same as above</span>
</code></pre>
<p>See: <a href="http://devdocs.io/rails/activerecord/attributeassignment">AttributeAssignment</a></p>
<h3 id="dirty">Dirty</h3>

<pre><code class="ruby">item.changed?
item.changed             <span class="hljs-comment"># [&#x27;name&#x27;]</span>
item.changed_attributes  <span class="hljs-comment"># { &#x27;name&#x27; =&gt; &#x27;Bob&#x27; } - original values</span>
item.changes             <span class="hljs-comment"># { &#x27;name&#x27; =&gt; [&#x27;Bob&#x27;, &#x27;Robert&#x27;] }</span>
item.previous_changes    <span class="hljs-comment"># available after #save</span>
item.restore_attributes
</code></pre>

<pre><code class="ruby">item.name = <span class="hljs-string">&#x27;Robert&#x27;</span>
item.name_was         <span class="hljs-comment"># &#x27;Bob&#x27;</span>
item.name_change      <span class="hljs-comment"># [ &#x27;Bob&#x27;, &#x27;Robert&#x27; ]</span>
item.name_changed?    <span class="hljs-comment"># true</span>
item.name_changed?(<span class="hljs-symbol">from:</span> <span class="hljs-string">&#x27;Bob&#x27;</span>, <span class="hljs-symbol">to:</span> <span class="hljs-string">&#x27;Robert&#x27;</span>)
</code></pre>
<p>See: <a href="http://devdocs.io/rails/activemodel/dirty">Dirty</a></p>
<h3 id="validations">Validations</h3>

<pre><code class="ruby">item.valid?
item.invalid?
</code></pre>
<p>See: <a href="http://devdocs.io/rails/activerecord/validations">Validations</a></p>
<h3 id="calculations">Calculations</h3>

<pre><code class="ruby">Person.count
Person.count(<span class="hljs-symbol">:age</span>)    <span class="hljs-comment"># counts non-nil&#x27;s</span>
</code></pre>

<pre><code class="ruby">Person.average(<span class="hljs-symbol">:age</span>)
Person.maximum(<span class="hljs-symbol">:age</span>)
Person.minimum(<span class="hljs-symbol">:age</span>)
Person.sum(<span class="hljs-string">&#x27;2 * age&#x27;</span>)
</code></pre>

<pre><code class="ruby">Person.calculate(<span class="hljs-symbol">:count</span>, <span class="hljs-symbol">:all</span>)
</code></pre>
<p>Advanced:</p>

<pre><code class="ruby">Person.distinct.count
Person.group(<span class="hljs-symbol">:city</span>).count
</code></pre>
<p>See: <a href="http://devdocs.io/rails/activerecord/calculations">Calculations</a></p>
<h3 id="dynamic-attribute-based-finders">Dynamic attribute-based finders</h3>
<p>Given a field called <code>name</code>:</p>

<pre><code class="ruby"><span class="hljs-comment"># Returns one record</span>
Person.find_by_name(name)
Person.find_last_by_name(name)
Person.find_or_create_by_name(name)
Person.find_or_initialize_by_name(name)
</code></pre>

<pre><code class="ruby"><span class="hljs-comment"># Returns a list of records</span>
Person.find_all_by_name(name)
</code></pre>

<pre><code class="ruby"><span class="hljs-comment"># Add a bang to make it raise an exception</span>
Person.find_by_name!(name)
</code></pre>

<pre><code class="ruby"><span class="hljs-comment"># You may use `scoped` instead of `find`</span>
Person.scoped_by_user_name
</code></pre>
<h2 id="associations">Associations</h2>
<h3 id="associations1">Associations</h3>

<ul>
<li><code>belongs_to</code></li>
<li><code>has_one</code></li>
<li><code>has_many</code></li>
<li><code>has_many :through</code></li>
<li><code>has_one :through</code></li>
<li><code>has_and_belongs_to_many</code></li>
</ul>
<h3 id="has-many">Has many</h3>

<pre><code class="ruby">belongs_to <span class="hljs-symbol">:parent</span>, <span class="hljs-symbol">:foreign_key</span> =&gt; <span class="hljs-string">&#x27;parent_id&#x27;</span> <span class="hljs-symbol">class_name:</span> <span class="hljs-string">&#x27;Folder&#x27;</span>
has_many <span class="hljs-symbol">:folders</span>, <span class="hljs-symbol">:foreign_key</span> =&gt; <span class="hljs-string">&#x27;parent_id&#x27;</span>, <span class="hljs-symbol">class_name:</span> <span class="hljs-string">&#x27;Folder&#x27;</span>

has_many <span class="hljs-symbol">:comments</span>,                -&gt; { order(<span class="hljs-string">&#x27;posted_on DESC&#x27;</span>) }
has_many <span class="hljs-symbol">:comments</span>,    <span class="hljs-symbol">:include</span>    =&gt; <span class="hljs-symbol">:author</span>
has_many <span class="hljs-symbol">:people</span>,      <span class="hljs-symbol">:class_name</span> =&gt; <span class="hljs-string">&quot;Person&quot;</span>
has_many <span class="hljs-symbol">:people</span>,      <span class="hljs-symbol">:conditions</span> =&gt; <span class="hljs-string">&quot;deleted = 0&quot;</span>
has_many <span class="hljs-symbol">:tracks</span>,                  -&gt; { order(<span class="hljs-symbol">:position</span>) }
has_many <span class="hljs-symbol">:comments</span>,    <span class="hljs-symbol">:dependent</span>  =&gt; <span class="hljs-symbol">:nullify</span>
has_many <span class="hljs-symbol">:comments</span>,    <span class="hljs-symbol">:dependent</span>  =&gt; <span class="hljs-symbol">:destroy</span>
has_many <span class="hljs-symbol">:tags</span>,        <span class="hljs-symbol">:as</span>         =&gt; <span class="hljs-symbol">:taggable</span>
has_many <span class="hljs-symbol">:reports</span>,     <span class="hljs-symbol">:readonly</span>   =&gt; <span class="hljs-literal">true</span>
has_many <span class="hljs-symbol">:subscribers</span>, <span class="hljs-symbol">:through</span>    =&gt; <span class="hljs-symbol">:subscriptions</span>, <span class="hljs-symbol">class_name:</span> <span class="hljs-string">&quot;User&quot;</span>, <span class="hljs-symbol">:source</span> =&gt; <span class="hljs-symbol">:user</span>
has_many <span class="hljs-symbol">:subscribers</span>, <span class="hljs-symbol">:finder_sql</span> =&gt;
    <span class="hljs-string">&#x27;SELECT DISTINCT people.* &#x27;</span> +
    <span class="hljs-string">&#x27;FROM people p, post_subscriptions ps &#x27;</span> +
    <span class="hljs-string">&#x27;WHERE ps.post_id = <span class="hljs-subst">#{id}</span> AND ps.person_id = p.id &#x27;</span> +
    <span class="hljs-string">&#x27;ORDER BY p.first_name&#x27;</span>
</code></pre>
<h3 id="belongs-to">belongs to</h3>

<pre><code class="ruby">belongs_to <span class="hljs-symbol">:author</span>,
  <span class="hljs-symbol">:dependent</span>      =&gt; <span class="hljs-symbol">:destroy</span>    <span class="hljs-comment"># or :delete</span>

  <span class="hljs-symbol">:class_name</span>     =&gt; <span class="hljs-string">&quot;Person&quot;</span>
  <span class="hljs-symbol">:select</span>         =&gt; <span class="hljs-string">&quot;*&quot;</span>
  <span class="hljs-symbol">:counter_cache</span>  =&gt; <span class="hljs-literal">true</span>
  <span class="hljs-symbol">:counter_cache</span>  =&gt; <span class="hljs-symbol">:custom_counter</span>
  <span class="hljs-symbol">:include</span>        =&gt; <span class="hljs-string">&quot;Book&quot;</span>
  <span class="hljs-symbol">:readonly</span>       =&gt; <span class="hljs-literal">true</span>

  <span class="hljs-symbol">:conditions</span>     =&gt; <span class="hljs-string">&#x27;published = true&#x27;</span>

  <span class="hljs-symbol">:touch</span>          =&gt; <span class="hljs-literal">true</span>
  <span class="hljs-symbol">:touch</span>          =&gt; <span class="hljs-symbol">:authors_last_updated_at</span>

  <span class="hljs-symbol">:primary_key</span>    =&gt; <span class="hljs-string">&quot;name&quot;</span>
  <span class="hljs-symbol">:foreign_key</span>    =&gt; <span class="hljs-string">&quot;author_name&quot;</span>
</code></pre>
<h3 id="many-to-many">Many-to-many</h3>
<p>If you have a join model:</p>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Programmer</span> &lt; ActiveRecord::Base</span>
  has_many <span class="hljs-symbol">:assignments</span>
  has_many <span class="hljs-symbol">:projects</span>, <span class="hljs-symbol">:through</span> =&gt; <span class="hljs-symbol">:assignments</span>
<span class="hljs-keyword">end</span>
</code></pre>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Project</span> &lt; ActiveRecord::Base</span>
  has_many <span class="hljs-symbol">:assignments</span>
  has_many <span class="hljs-symbol">:programmers</span>, <span class="hljs-symbol">:through</span> =&gt; <span class="hljs-symbol">:assignments</span>
<span class="hljs-keyword">end</span>
</code></pre>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Assignment</span></span>
  belongs_to <span class="hljs-symbol">:project</span>
  belongs_to <span class="hljs-symbol">:programmer</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="many-to-many-habtm-">Many-to-many (HABTM)</h3>

<pre><code class="ruby">has_and_belongs_to_many <span class="hljs-symbol">:projects</span>
has_and_belongs_to_many <span class="hljs-symbol">:projects</span>, <span class="hljs-symbol">:include</span> =&gt; [ <span class="hljs-symbol">:milestones</span>, <span class="hljs-symbol">:manager</span> ]
has_and_belongs_to_many <span class="hljs-symbol">:nations</span>, <span class="hljs-symbol">:class_name</span> =&gt; <span class="hljs-string">&quot;Country&quot;</span>
has_and_belongs_to_many <span class="hljs-symbol">:categories</span>, <span class="hljs-symbol">:join_table</span> =&gt; <span class="hljs-string">&quot;prods_cats&quot;</span>
has_and_belongs_to_many <span class="hljs-symbol">:categories</span>, <span class="hljs-symbol">:readonly</span> =&gt; <span class="hljs-literal">true</span>
has_and_belongs_to_many <span class="hljs-symbol">:active_projects</span>, <span class="hljs-symbol">:join_table</span> =&gt; <span class="hljs-string">&#x27;developers_projects&#x27;</span>, <span class="hljs-symbol">:delete_sql</span> =&gt;
<span class="hljs-string">&quot;DELETE FROM developers_projects WHERE active=1 AND developer_id = <span class="hljs-subst">#{id}</span> AND project_id = <span class="hljs-subst">#{record.id}</span>&quot;</span>
</code></pre>
<h3 id="polymorphic-associations">Polymorphic associations</h3>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span></span>
  has_many <span class="hljs-symbol">:attachments</span>, <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:parent</span>
<span class="hljs-keyword">end</span>
</code></pre>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Image</span></span>
  belongs_to <span class="hljs-symbol">:parent</span>, <span class="hljs-symbol">polymorphic:</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>And in migrations:</p>

<pre><code class="ruby">create_table <span class="hljs-symbol">:images</span> <span class="hljs-keyword">do</span> <span class="hljs-params">|t|</span>
  t.references <span class="hljs-symbol">:post</span>, <span class="hljs-symbol">polymorphic:</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h2 id="validation">Validation</h2>
<h3 id="validation1">Validation</h3>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> &lt; ActiveRecord::Base</span>
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Presence</span>
  validates <span class="hljs-symbol">:name</span>,     <span class="hljs-symbol">presence:</span> <span class="hljs-literal">true</span>
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Acceptance</span>
  validates <span class="hljs-symbol">:terms</span>,    <span class="hljs-symbol">acceptance:</span> <span class="hljs-literal">true</span>
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Confirm</span>
  validates <span class="hljs-symbol">:email</span>,    <span class="hljs-symbol">confirmation:</span> <span class="hljs-literal">true</span>
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Unique</span>
  validates <span class="hljs-symbol">:slug</span>,     <span class="hljs-symbol">uniqueness:</span> <span class="hljs-literal">true</span>
  validates <span class="hljs-symbol">:slug</span>,     <span class="hljs-symbol">uniqueness:</span> { <span class="hljs-symbol">case_sensitive:</span> <span class="hljs-literal">false</span> }
  validates <span class="hljs-symbol">:holiday</span>,  <span class="hljs-symbol">uniqueness:</span> { <span class="hljs-symbol">scope:</span> <span class="hljs-symbol">:year</span>, <span class="hljs-symbol">message:</span> <span class="hljs-string">&#x27;yearly only&#x27;</span> }
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Format</span>
  validates <span class="hljs-symbol">:code</span>,     <span class="hljs-symbol">format:</span> /regex/
  validates <span class="hljs-symbol">:code</span>,     <span class="hljs-symbol">format:</span> { <span class="hljs-symbol">with:</span> /regex/ }
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Length</span>
  validates <span class="hljs-symbol">:name</span>,     <span class="hljs-symbol">length:</span> { <span class="hljs-symbol">minimum:</span> <span class="hljs-number">2</span> }
  validates <span class="hljs-symbol">:bio</span>,      <span class="hljs-symbol">length:</span> { <span class="hljs-symbol">maximum:</span> <span class="hljs-number">500</span> }
  validates <span class="hljs-symbol">:password</span>, <span class="hljs-symbol">length:</span> { <span class="hljs-symbol">in:</span> =&gt; <span class="hljs-number">6</span>..<span class="hljs-number">20</span> }
  validates <span class="hljs-symbol">:number</span>,   <span class="hljs-symbol">length:</span> { <span class="hljs-symbol">is:</span> =&gt; <span class="hljs-number">6</span> }
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Include/exclude</span>
  validates <span class="hljs-symbol">:gender</span>,   <span class="hljs-symbol">inclusion:</span> <span class="hljs-string">%w(male female)</span>
  validates <span class="hljs-symbol">:gender</span>,   <span class="hljs-symbol">inclusion:</span> { <span class="hljs-symbol">in:</span> <span class="hljs-string">%w(male female)</span> }
  validates <span class="hljs-symbol">:lol</span>,      <span class="hljs-symbol">exclusion:</span> <span class="hljs-string">%w(xyz)</span>
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Numeric</span>
  validates <span class="hljs-symbol">:points</span>,   <span class="hljs-symbol">numericality:</span> <span class="hljs-literal">true</span>
  validates <span class="hljs-symbol">:played</span>,   <span class="hljs-symbol">numericality:</span> { <span class="hljs-symbol">only_integer:</span> <span class="hljs-literal">true</span> }
  <span class="hljs-comment"># ... greater_than, greater_than_or_equal_to,</span>
  <span class="hljs-comment"># ... less_than, less_than_or_equal_to</span>
  <span class="hljs-comment"># ... odd, even, equal_to</span>
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Validate the associated records to ensure they&#x27;re valid as well</span>
  has_many <span class="hljs-symbol">:books</span>
  validates_associated <span class="hljs-symbol">:books</span>
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Length (full options)</span>
  validates <span class="hljs-symbol">:content</span>, <span class="hljs-symbol">length:</span> {
    <span class="hljs-symbol">minimum:</span>   <span class="hljs-number">300</span>,
    <span class="hljs-symbol">maximum:</span>   <span class="hljs-number">400</span>,
    <span class="hljs-symbol">tokenizer:</span> <span class="hljs-built_in">lambda</span> { <span class="hljs-params">|str|</span> str.scan(<span class="hljs-regexp">/\w+/</span>) },
    <span class="hljs-symbol">too_short:</span> <span class="hljs-string">&quot;must have at least %{count} words&quot;</span>,
    <span class="hljs-symbol">too_long:</span>  <span class="hljs-string">&quot;must have at most %{count} words&quot;</span> }
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Multiple</span>
  validates <span class="hljs-symbol">:login</span>, <span class="hljs-symbol">:email</span>, <span class="hljs-symbol">presence:</span> <span class="hljs-literal">true</span>
</code></pre>

<pre><code class="ruby">  <span class="hljs-comment"># Conditional</span>
  validates <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">presence:</span> <span class="hljs-literal">true</span>, <span class="hljs-symbol">if:</span> <span class="hljs-symbol">:published?</span>
  validates <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">presence:</span> <span class="hljs-literal">true</span>, <span class="hljs-symbol">if:</span> <span class="hljs-built_in">lambda</span> { <span class="hljs-params">|obj|</span> .. }
</code></pre>

<pre><code class="ruby">  validates <span class="hljs-symbol">:title</span>, <span class="hljs-symbol">presence:</span> <span class="hljs-literal">true</span>, <span class="hljs-symbol">on:</span> <span class="hljs-symbol">:save</span>   <span class="hljs-comment"># :save | :create | :update</span>
</code></pre>

<pre><code class="ruby"><span class="hljs-keyword">end</span>
</code></pre>
<h3 id="custom-validations">Custom validations</h3>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> &lt; ActiveRecord::Base</span>
  validate <span class="hljs-symbol">:foo_cant_be_nil</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo_cant_be_nil</span></span>
    errors.add(<span class="hljs-symbol">:foo</span>, <span class="hljs-string">&#x27;cant be nil&#x27;</span>)  <span class="hljs-keyword">if</span> foo.<span class="hljs-literal">nil</span>?
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="errors">Errors</h3>

<pre><code class="ruby">record.errors.valid?      <span class="hljs-comment"># → false</span>
record.errors             <span class="hljs-comment"># → { :name =&gt; [&quot;can&#x27;t be blank&quot;] }</span>
record.errors.messages    <span class="hljs-comment"># → { :name =&gt; [&quot;can&#x27;t be blank&quot;] }</span>
</code></pre>

<pre><code class="ruby">record.errors[<span class="hljs-symbol">:name</span>].any?
</code></pre>
<h2 id="other-api">Other API</h2>
<h3 id="callbacks">Callbacks</h3>

<ul>
<li><a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html">Guides: callbacks</a></li>
</ul>
<h3 id="mass-updates">Mass updates</h3>

<pre><code class="ruby"><span class="hljs-comment"># Updates person id 15</span>
Person.update <span class="hljs-number">15</span>, <span class="hljs-symbol">name:</span> <span class="hljs-string">&quot;John&quot;</span>, <span class="hljs-symbol">age:</span> <span class="hljs-number">24</span>
Person.update [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [{<span class="hljs-symbol">name:</span> <span class="hljs-string">&quot;John&quot;</span>}, {<span class="hljs-symbol">name:</span> <span class="hljs-string">&quot;foo&quot;</span>}]
</code></pre>
<h3 id="joining">Joining</h3>

<pre><code class="ruby"><span class="hljs-comment"># Basic joins</span>
Student.joins(<span class="hljs-symbol">:schools</span>).where(<span class="hljs-symbol">schools:</span> { <span class="hljs-symbol">type:</span> <span class="hljs-string">&#x27;public&#x27;</span> })
Student.joins(<span class="hljs-symbol">:schools</span>).where(<span class="hljs-string">&#x27;schools.type&#x27;</span> =&gt; <span class="hljs-string">&#x27;public&#x27;</span> )
</code></pre>

<pre><code class="ruby"><span class="hljs-comment"># Multiple associations</span>
Article.joins(<span class="hljs-symbol">:category</span>, <span class="hljs-symbol">:comments</span>)
</code></pre>

<pre><code class="ruby"><span class="hljs-comment"># Nested associations</span>
Article.joins(<span class="hljs-symbol">comments:</span> <span class="hljs-symbol">:guest</span>)
</code></pre>

<pre><code class="ruby"><span class="hljs-comment"># SQL</span>
Author.joins(
  <span class="hljs-string">&#x27;INNER JOIN posts &#x27;</span> +
  <span class="hljs-string">&#x27;ON posts.author_id = authors.id &#x27;</span> +
  <span class="hljs-string">&#x27;AND posts.published = &quot;t&quot;&#x27;</span>
)
</code></pre>
<h3 id="where-interpolation">Where interpolation</h3>

<pre><code class="ruby">where(<span class="hljs-string">&#x27;name = ?&#x27;</span>, <span class="hljs-string">&#x27;John&#x27;</span>)
where([<span class="hljs-string">&#x27;name = :name&#x27;</span>, { <span class="hljs-symbol">name:</span> <span class="hljs-string">&#x27;John&#x27;</span> }])
</code></pre>
<h3 id="serialize">Serialize</h3>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> &lt; ActiveRecord::Base</span>
  serialize <span class="hljs-symbol">:preferences</span>
<span class="hljs-keyword">end</span>
</code></pre>

<pre><code class="ruby">user = User.create(
  <span class="hljs-symbol">preferences:</span> {
    <span class="hljs-string">&#x27;background&#x27;</span> =&gt; <span class="hljs-string">&#x27;black&#x27;</span>,
    <span class="hljs-string">&#x27;display&#x27;</span> =&gt; <span class="hljs-string">&#x27;large&#x27;</span>
  }
)
</code></pre>
<p>You can also specify a class option as the second parameter that’ll raise an 
exception if a serialized object is retrieved as a descendant of a class not in 
the hierarchy.</p>

<pre><code class="ruby"><span class="hljs-comment"># Only Hash allowed!</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> &lt; ActiveRecord::Base</span>
  serialize <span class="hljs-symbol">:preferences</span>, Hash
<span class="hljs-keyword">end</span>
</code></pre>

<pre><code class="ruby"><span class="hljs-comment"># Reading it raises SerializationTypeMismatch</span>
user = User.create(<span class="hljs-symbol">preferences:</span> <span class="hljs-string">%w(one two three)</span>)
User.find(user.id).preferences
</code></pre>
<h2 id="other-tricks">Other tricks</h2>
<h3 id="overriding-accessors">Overriding accessors</h3>

<pre><code class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> &lt; ActiveRecord::Base</span>
  <span class="hljs-comment"># Uses an integer of seconds to hold the length of the song</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">length=</span><span class="hljs-params">(minutes)</span></span>
    write_attribute(<span class="hljs-symbol">:length</span>, minutes.to_i * <span class="hljs-number">60</span>)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">length</span></span>
    read_attribute(<span class="hljs-symbol">:length</span>) / <span class="hljs-number">60</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>See: <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">http://api.rubyonrails.org/classes/ActiveRecord/Base.html</a></p>
<h2 id="callbacks1">Callbacks</h2>

<ul>
<li>after_create</li>
<li>after_initialize</li>
<li>after_validation</li>
<li>after_save</li>
<li>after_commit</li>
</ul>

</div>
</body>  
</html>