<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sequel cheatsheet</title>
  <link href="s/main.css" rel="stylesheet" />
  <script src="s/main.js"></script>
</head>

<body onload="start()">
  <div class="breadcrumbs"><a href="/">Home</a> / <a href="index.html">cheatsheets</a> / Sequel cheatsheet</div>
  <div class="edit">
      <a href="https://github.com/kjk/blog/blob/master/www/cheatsheets/devhints/sequel.md" >edit</a>
  </div>
  <div class="toc">
<b>Main</b>: <a href="#open-a-database">Open a database</a>, <a href="#open-an-sqlite-memory-database">Open an SQLite memory database</a>, <a href="#logging-sql-statements">Logging SQL statements</a>, <a href="#using-raw-sql">Using raw SQL</a>, <a href="#create-a-dataset">Create a dataset</a>, <a href="#most-dataset-methods-are-chainable">Most dataset methods are chainable</a>, <a href="#insert-rows">Insert rows</a>, <a href="#retrieve-rows">Retrieve rows</a>, <a href="#update-delete-rows">Update/Delete rows</a>, <a href="#datasets-are-enumerable">Datasets are Enumerable</a>, <a href="#filtering-see-also-doc-dataset_filtering-rdoc-">Filtering (see also doc/dataset_filtering.rdoc)</a>, <a href="#ordering">Ordering</a>, <a href="#limit-offset">Limit/Offset</a>, <a href="#joins">Joins</a>, <a href="#aggregate-functions-methods">Aggregate functions methods</a>, <a href="#sql-functions-literals">SQL Functions / Literals</a>, <a href="#schema-manipulation">Schema Manipulation</a>, <a href="#aliasing">Aliasing</a>, <a href="#transactions">Transactions</a>, <a href="#miscellaneous-">Miscellaneous:</a>, <a href="#documents">Documents</a>, <a href="#alter-table">Alter table</a>, <a href="#model-associations">Model associations</a>, <a href="#validations">Validations</a>, <a href="#model-stuff">Model stuff</a>, <a href="#callbacks">Callbacks</a>, <a href="#schema">Schema</a>, <a href="#unrestrict-primary-key">Unrestrict primary key</a><br></div>


  <div id="start"></div>
  <div id="wrapped-content"></div>
<div id="content">
<h3 id="open-a-database">Open a database</h3>

<pre><code>require <span class="hljs-string">&#x27;rubygems&#x27;</span>
require <span class="hljs-string">&#x27;sequel&#x27;</span>

DB = Sequel.sqlite(<span class="hljs-string">&#x27;my_blog.db&#x27;</span>)
DB = Sequel.connect(<span class="hljs-string">&#x27;postgres://user:password@localhost/my_db&#x27;</span>)
DB = Sequel.postgres(<span class="hljs-string">&#x27;my_db&#x27;</span>, :<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="hljs-string">&#x27;user&#x27;</span>, :<span class="hljs-function"><span class="hljs-params">password</span> =&gt;</span> <span class="hljs-string">&#x27;password&#x27;</span>, :<span class="hljs-function"><span class="hljs-params">host</span> =&gt;</span> <span class="hljs-string">&#x27;localhost&#x27;</span>)
DB = Sequel.ado(<span class="hljs-string">&#x27;mydb&#x27;</span>)
</code></pre>
<h3 id="open-an-sqlite-memory-database">Open an SQLite memory database</h3>
<p>Without a filename argument, the sqlite adapter will setup a new sqlite database in memory.</p>

<pre><code><span class="hljs-attribute">DB</span> <span class="hljs-operator">=</span> Sequel.sqlite
</code></pre>
<h3 id="logging-sql-statements">Logging SQL statements</h3>

<pre><code>require <span class="hljs-string">&#x27;logger&#x27;</span>
DB = Sequel.sqlite <span class="hljs-string">&#x27;&#x27;</span>, :<span class="hljs-type">loggers </span>=&gt; [Logger.<span class="hljs-keyword">new</span><span class="hljs-type"></span>($stdout)]
<span class="hljs-meta"># or</span>
DB.loggers &lt;&lt; Logger.<span class="hljs-keyword">new</span><span class="hljs-type"></span>(...)
</code></pre>
<h3 id="using-raw-sql">Using raw SQL</h3>

<pre><code>DB.run &quot;<span class="hljs-keyword">CREATE</span> TABLE users (name VARCHAR(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>, age INT(<span class="hljs-number">3</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>)<span class="hljs-string">&quot;
dataset = DB[&quot;</span><span class="hljs-keyword">SELECT</span> age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name = ?<span class="hljs-string">&quot;, name]
dataset.map(:age)
DB.fetch(&quot;</span><span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> users<span class="hljs-string">&quot;) do |row|
  p row[:name]
end</span>
</code></pre>
<h3 id="create-a-dataset">Create a dataset</h3>

<pre><code><span class="hljs-attr">dataset</span> = DB[:items]
<span class="hljs-attr">dataset</span> = DB.from(:items)
</code></pre>
<h3 id="most-dataset-methods-are-chainable">Most dataset methods are chainable</h3>

<pre><code>dataset = DB[<span class="hljs-symbol">:managers</span>].where(<span class="hljs-symbol">:salary</span> =&gt; <span class="hljs-number">5000</span>..<span class="hljs-number">10000</span>).order(<span class="hljs-symbol">:name</span>, <span class="hljs-symbol">:department</span>)
</code></pre>
<h3 id="insert-rows">Insert rows</h3>

<pre><code>dataset.insert(:<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> <span class="hljs-string">&#x27;Sharon&#x27;</span>, :<span class="hljs-function"><span class="hljs-params">grade</span> =&gt;</span> <span class="hljs-number">50</span>)
</code></pre>
<h3 id="retrieve-rows">Retrieve rows</h3>

<pre><code>dataset.each{|<span class="hljs-type">r</span>| <span class="hljs-type">p</span> r}
dataset.all # =&gt; [{...}, {...}, ...]
dataset.<span class="hljs-built_in">first</span> # =&gt; {...}
</code></pre>
<h3 id="update-delete-rows">Update/Delete rows</h3>

<pre><code>dataset.<span class="hljs-keyword">filter</span>(~:active).<span class="hljs-keyword">delete</span>
dataset.<span class="hljs-keyword">filter</span>(<span class="hljs-string">&#x27;price &lt; ?&#x27;</span>, <span class="hljs-number">100</span>).<span class="hljs-keyword">update</span>(:active =&gt; <span class="hljs-keyword">true</span>)
</code></pre>
<h3 id="datasets-are-enumerable">Datasets are Enumerable</h3>

<pre><code>dataset.map{|<span class="hljs-type">r</span>| <span class="hljs-type">r</span>[:name]}
dataset.map(:name) # same <span class="hljs-built_in">as</span> above

dataset.inject(<span class="hljs-number">0</span>){|<span class="hljs-type">sum</span>, r| <span class="hljs-type">sum</span> + r[:value]}
dataset.<span class="hljs-built_in">sum</span>(:value) # same <span class="hljs-built_in">as</span> above
</code></pre>
<h3 id="filtering-see-also-doc-dataset_filtering-rdoc-">Filtering (see also doc/dataset_filtering.rdoc)</h3>
<h4 id="equality">Equality</h4>

<pre><code>dataset.<span class="hljs-keyword">filter</span>(:<span class="hljs-type">name</span> =&gt; <span class="hljs-string">&#x27;abc&#x27;</span>)
dataset.<span class="hljs-keyword">filter</span>(<span class="hljs-string">&#x27;name = ?&#x27;</span>, <span class="hljs-string">&#x27;abc&#x27;</span>)
</code></pre>
<h4 id="inequality">Inequality</h4>

<pre><code><span class="hljs-attribute">dataset</span>.filter{value &gt; <span class="hljs-number">100</span>}
<span class="hljs-attribute">dataset</span>.exclude{value &lt;= <span class="hljs-number">100</span>}
</code></pre>
<h4 id="inclusion">Inclusion</h4>

<pre><code>dataset.filter(<span class="hljs-symbol">:value</span> =&gt; <span class="hljs-number">50</span>..<span class="hljs-number">100</span>)
dataset.where{(value &gt;= <span class="hljs-number">50</span>) &amp; (value &lt;= <span class="hljs-number">100</span>)}

dataset.where(<span class="hljs-string">&#x27;value IN ?&#x27;</span>, [<span class="hljs-number">50</span>,<span class="hljs-number">75</span>,<span class="hljs-number">100</span>])
dataset.where(<span class="hljs-symbol">:value=&gt;</span>[<span class="hljs-number">50</span>,<span class="hljs-number">75</span>,<span class="hljs-number">100</span>])

dataset.where(<span class="hljs-symbol">:id=&gt;other_dataset</span>.select(<span class="hljs-symbol">:other_id</span>))
</code></pre>
<h4 id="subselects-as-scalar-values">Subselects as scalar values</h4>

<pre><code>dataset.<span class="hljs-keyword">where</span>(<span class="hljs-string">&#x27;price &gt; (SELECT avg(price) + 100 FROM table)&#x27;</span>)
dataset.<span class="hljs-keyword">filter</span>{price &gt; dataset.<span class="hljs-keyword">select</span>(avg(price) + <span class="hljs-number">100</span>)}
</code></pre>
<h4 id="like-regexp">LIKE/Regexp</h4>

<pre><code>DB[<span class="hljs-symbol">:items</span>].filter(<span class="hljs-symbol">:name</span>.like(<span class="hljs-string">&#x27;AL%&#x27;</span>))
DB[<span class="hljs-symbol">:items</span>].filter(<span class="hljs-symbol">:name</span> =&gt; <span class="hljs-regexp">/^AL/</span>)
</code></pre>
<h4 id="and-or-not">AND/OR/NOT</h4>

<pre><code>DB[:items].<span class="hljs-keyword">filter</span>{(x &gt; <span class="hljs-number">5</span>) &amp; (y &gt; <span class="hljs-number">10</span>)}.<span class="hljs-keyword">sql</span> 
# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> items <span class="hljs-keyword">WHERE</span> ((x &gt; <span class="hljs-number">5</span>) <span class="hljs-keyword">AND</span> (y &gt; <span class="hljs-number">10</span>))

DB[:items].<span class="hljs-keyword">filter</span>().<span class="hljs-keyword">sql</span> 
# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> items <span class="hljs-keyword">WHERE</span> (((x = <span class="hljs-number">1</span>) <span class="hljs-keyword">OR</span> (y = <span class="hljs-number">2</span>)) <span class="hljs-keyword">AND</span> (z != <span class="hljs-number">3</span>))
</code></pre>
<h4 id="mathematical-operators">Mathematical operators</h4>

<pre><code>DB[:items].<span class="hljs-keyword">filter</span>((:x + :y) &gt; :z).<span class="hljs-keyword">sql</span> 
# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> items <span class="hljs-keyword">WHERE</span> ((x + y) &gt; z)

DB[:items].<span class="hljs-keyword">filter</span>{price - <span class="hljs-number">100</span> &lt; avg(price)}.<span class="hljs-keyword">sql</span> 
# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> items <span class="hljs-keyword">WHERE</span> ((price - <span class="hljs-number">100</span>) &lt; avg(price))
</code></pre>
<h3 id="ordering">Ordering</h3>

<pre><code>dataset.order(<span class="hljs-symbol">:kind</span>)
dataset.reverse_order(<span class="hljs-symbol">:kind</span>)
dataset.order(<span class="hljs-symbol">:kind</span>.desc, <span class="hljs-symbol">:name</span>)
</code></pre>
<h3 id="limit-offset">Limit/Offset</h3>

<pre><code><span class="hljs-attribute">dataset</span>.limit(<span class="hljs-number">30</span>) # LIMIT <span class="hljs-number">30</span>
<span class="hljs-attribute">dataset</span>.limit(<span class="hljs-number">30</span>, <span class="hljs-number">10</span>) # LIMIT <span class="hljs-number">30</span> OFFSET <span class="hljs-number">10</span>
</code></pre>
<h3 id="joins">Joins</h3>

<pre><code>DB[:items].left_outer_join(:categories, :id =&gt; :category_id).<span class="hljs-keyword">sql</span> 
# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> items <span class="hljs-keyword">LEFT OUTER JOIN</span> categories <span class="hljs-keyword">ON</span> categories.id = items.category_id

DB[:items].<span class="hljs-keyword">join</span>(:categories, :id =&gt; :category_id).<span class="hljs-keyword">join</span>(:<span class="hljs-keyword">groups</span>, :id =&gt; :items__group_id) 
# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> items <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> categories <span class="hljs-keyword">ON</span> categories.id = items.category_id <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">groups</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">groups</span>.id = items.group_id
</code></pre>
<h3 id="aggregate-functions-methods">Aggregate functions methods</h3>

<pre><code>dataset.count <span class="hljs-comment">#=&gt; record count</span>
dataset.max(<span class="hljs-symbol">:price</span>)
dataset.min(<span class="hljs-symbol">:price</span>)
dataset.avg(<span class="hljs-symbol">:price</span>)
dataset.sum(<span class="hljs-symbol">:stock</span>)

dataset.group_and_count(<span class="hljs-symbol">:category</span>)
dataset.group(<span class="hljs-symbol">:category</span>).select(<span class="hljs-symbol">:category</span>, <span class="hljs-symbol">:AVG</span>.sql_function(<span class="hljs-symbol">:price</span>))
</code></pre>
<h3 id="sql-functions-literals">SQL Functions / Literals</h3>

<pre><code>dataset.update(:<span class="hljs-function"><span class="hljs-params">updated_at</span> =&gt;</span> :NOW.sql_function)
dataset.update(:<span class="hljs-function"><span class="hljs-params">updated_at</span> =&gt;</span> <span class="hljs-string">&#x27;NOW()&#x27;</span>.lit)

dataset.update(:<span class="hljs-function"><span class="hljs-params">updated_at</span> =&gt;</span> <span class="hljs-string">&quot;DateValue(&#x27;1/1/2001&#x27;)&quot;</span>.lit)
dataset.update(:<span class="hljs-function"><span class="hljs-params">updated_at</span> =&gt;</span> :DateValue.sql_function(<span class="hljs-string">&#x27;1/1/2001&#x27;</span>))
</code></pre>
<h3 id="schema-manipulation">Schema Manipulation</h3>

<pre><code>DB.create_table <span class="hljs-symbol">:items</span> <span class="hljs-keyword">do</span>
  primary_key <span class="hljs-symbol">:id</span>
  String <span class="hljs-symbol">:name</span>, <span class="hljs-symbol">:unique</span> =&gt; <span class="hljs-keyword">true</span>, <span class="hljs-symbol">:null</span> =&gt; <span class="hljs-keyword">false</span>
  TrueClass <span class="hljs-symbol">:active</span>, <span class="hljs-symbol">:default</span> =&gt; <span class="hljs-keyword">true</span>
  foreign_key <span class="hljs-symbol">:category_id</span>, <span class="hljs-symbol">:categories</span>
  DateTime <span class="hljs-symbol">:created_at</span>

  index <span class="hljs-symbol">:created_at</span>
<span class="hljs-keyword">end</span>

DB.drop_table <span class="hljs-symbol">:items</span>

DB.create_table <span class="hljs-symbol">:test</span> <span class="hljs-keyword">do</span>
  String <span class="hljs-symbol">:zipcode</span>
  enum <span class="hljs-symbol">:system</span>, <span class="hljs-symbol">:elements</span> =&gt; [<span class="hljs-string">&#x27;mac&#x27;</span>, <span class="hljs-string">&#x27;linux&#x27;</span>, <span class="hljs-string">&#x27;windows&#x27;</span>]
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="aliasing">Aliasing</h3>

<pre><code>DB[:items].<span class="hljs-keyword">select</span>(:<span class="hljs-type">name</span>.<span class="hljs-keyword">as</span>(:item_name))
DB[:items].<span class="hljs-keyword">select</span>(:name___item_name)
DB[:items___items_table].<span class="hljs-keyword">select</span>(:items_table__name___item_name)
# <span class="hljs-keyword">SELECT</span> items_table.name <span class="hljs-keyword">AS</span> item_name <span class="hljs-keyword">FROM</span> items <span class="hljs-keyword">AS</span> items_table
</code></pre>
<h3 id="transactions">Transactions</h3>

<pre><code>DB.transaction <span class="hljs-keyword">do</span>
  dataset.insert(<span class="hljs-symbol">:first_name</span> =&gt; <span class="hljs-string">&#x27;Inigo&#x27;</span>, <span class="hljs-symbol">:last_name</span> =&gt; <span class="hljs-string">&#x27;Montoya&#x27;</span>)
  dataset.insert(<span class="hljs-symbol">:first_name</span> =&gt; <span class="hljs-string">&#x27;Farm&#x27;</span>, <span class="hljs-symbol">:last_name</span> =&gt; <span class="hljs-string">&#x27;Boy&#x27;</span>)
<span class="hljs-keyword">end</span> <span class="hljs-comment"># Either both are inserted or neither are inserted</span>
</code></pre>
<p>Database#transaction is re-entrant:</p>

<pre><code>DB.<span class="hljs-keyword">transaction</span> <span class="hljs-keyword">do</span> # <span class="hljs-keyword">BEGIN</span> issued <span class="hljs-keyword">only</span> here
  DB.<span class="hljs-keyword">transaction</span>
    dataset &lt;&lt; 
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span> # <span class="hljs-keyword">COMMIT</span> issued <span class="hljs-keyword">only</span> here
</code></pre>
<p>Transactions are aborted if an error is raised:</p>

<pre><code>DB.<span class="hljs-keyword">transaction</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">raise</span> &quot;some error occurred&quot;
<span class="hljs-keyword">end</span> # <span class="hljs-keyword">ROLLBACK</span> issued <span class="hljs-keyword">and</span> the error <span class="hljs-keyword">is</span> re-raised
</code></pre>
<p>Transactions can also be aborted by raising Sequel::Rollback:</p>

<pre><code>DB.<span class="hljs-keyword">transaction</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">raise</span>(Sequel::<span class="hljs-keyword">Rollback</span>) <span class="hljs-keyword">if</span> something_bad_happened
<span class="hljs-keyword">end</span> # <span class="hljs-keyword">ROLLBACK</span> issued <span class="hljs-keyword">and</span> <span class="hljs-keyword">no</span> error raised
</code></pre>
<p>Savepoints can be used if the database supports it:</p>

<pre><code>DB.transaction <span class="hljs-keyword">do</span>
  dataset &lt;&lt;  <span class="hljs-comment"># Inserted</span>
  DB.transaction(<span class="hljs-symbol">:savepoint=&gt;true</span>) <span class="hljs-comment"># This savepoint is rolled back</span>
    dataset &lt;&lt;  <span class="hljs-comment"># Not inserted</span>
    raise(Sequel::Rollback) if something_bad_happened
  <span class="hljs-keyword">end</span>
  dataset &lt;&lt;  <span class="hljs-comment"># Inserted</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="miscellaneous-">Miscellaneous:</h3>

<pre><code>dataset.sql # &quot;<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> items<span class="hljs-string">&quot;
dataset.delete_sql # &quot;</span><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> items<span class="hljs-string">&quot;
dataset.where(:name =&gt; &#x27;sequel&#x27;).exists # &quot;</span><span class="hljs-keyword">EXISTS</span> ( <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> items <span class="hljs-keyword">WHERE</span> name = <span class="hljs-string">&#x27;sequel&#x27;</span> )<span class="hljs-string">&quot;
dataset.columns #=&gt; array of columns in the result set, does a SELECT
DB.schema(:items) =&gt; [[:id, ], ...]</span>
</code></pre>
<hr>
<h3 id="documents">Documents</h3>

<pre><code>http:<span class="hljs-regexp">//</span>sequel.rubyforge.org<span class="hljs-regexp">/rdoc/</span>files<span class="hljs-regexp">/doc/</span>association_basics_rdoc.html
http:<span class="hljs-regexp">//</span>sequel.rubyforge.org<span class="hljs-regexp">/rdoc/</span>classes<span class="hljs-regexp">/Sequel/</span>Schema/Generator.html
http:<span class="hljs-regexp">//</span>sequel.rubyforge.org<span class="hljs-regexp">/rdoc/</span>files<span class="hljs-regexp">/doc/</span>validations_rdoc.html
http:<span class="hljs-regexp">//</span>sequel.rubyforge.org<span class="hljs-regexp">/rdoc/</span>classes<span class="hljs-regexp">/Sequel/</span>Model.html
</code></pre>
<h3 id="alter-table">Alter table</h3>

<pre><code>database.alter_table <span class="hljs-symbol">:deals</span> <span class="hljs-keyword">do</span>
  add_column <span class="hljs-symbol">:name</span>, String
  drop_column <span class="hljs-symbol">:column_name</span>
  rename_column <span class="hljs-symbol">:from</span>, <span class="hljs-symbol">:to</span>

  add_constraint <span class="hljs-symbol">:valid_name</span>, <span class="hljs-symbol">:name</span>.like(<span class="hljs-string">&#x27;A%&#x27;</span>)
  drop_constraint <span class="hljs-symbol">:constraint</span>

  add_full_text_index <span class="hljs-symbol">:body</span>
  add_spacial_index [columns]

  add_index <span class="hljs-symbol">:price</span>
  drop_index <span class="hljs-symbol">:index</span>

  add_foreign_key <span class="hljs-symbol">:artist_id</span>, <span class="hljs-symbol">:table</span>
  add_primary_key <span class="hljs-symbol">:id</span>
  add_unique_constraint [columns]
  set_column_allow_null <span class="hljs-symbol">:foo</span>, <span class="hljs-keyword">false</span>
  set_column_default <span class="hljs-symbol">:title</span>, <span class="hljs-string">&#x27;&#x27;</span>

  set_column_type <span class="hljs-symbol">:price</span>, <span class="hljs-string">&#x27;char(10)&#x27;</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="model-associations">Model associations</h3>

<pre><code>class Deal &lt; Sequel::Model

  <span class="hljs-comment"># Us (left) &lt;=&gt; Them (right)</span>
  many_to_many  <span class="hljs-symbol">:images</span>,
    <span class="hljs-symbol">left_id:</span>    <span class="hljs-symbol">:deal_id</span>,
    <span class="hljs-symbol">right_id:</span>   <span class="hljs-symbol">:image_id</span>,
    <span class="hljs-symbol">join_table:</span> <span class="hljs-symbol">:image_links</span>

  one_to_many   <span class="hljs-symbol">:files</span>,
    <span class="hljs-symbol">key:</span>        <span class="hljs-symbol">:deal_id</span>,
    <span class="hljs-symbol">class:</span>      <span class="hljs-symbol">:DataFile</span>,

  many_to_one   <span class="hljs-symbol">:parent</span>, <span class="hljs-symbol">class:</span> <span class="hljs-keyword">self</span>
  one_to_many   <span class="hljs-symbol">:children</span>, <span class="hljs-symbol">key:</span> <span class="hljs-symbol">:parent_id</span>, <span class="hljs-symbol">class:</span> <span class="hljs-keyword">self</span>

  one_to_many <span class="hljs-symbol">:gold_albums</span>, <span class="hljs-symbol">class:</span> <span class="hljs-symbol">:Album</span> <span class="hljs-keyword">do</span> |ds|
    ds.filter { copies_sold &gt; <span class="hljs-number">50000</span> }
  <span class="hljs-keyword">end</span>
</code></pre>
<p>Provided by many_to_many</p>

<pre><code>Deal<span class="hljs-selector-attr">[1]</span><span class="hljs-selector-class">.images</span>
Deal<span class="hljs-selector-attr">[1]</span><span class="hljs-selector-class">.add_image</span>
Deal<span class="hljs-selector-attr">[1]</span><span class="hljs-selector-class">.remove_image</span>
Deal<span class="hljs-selector-attr">[1]</span>.remove_all_images
</code></pre>
<h3 id="validations">Validations</h3>

<pre><code>  def <span class="hljs-keyword">validate</span>
    super
    errors.<span class="hljs-keyword">add</span>(:<span class="hljs-type">name</span>, <span class="hljs-string">&#x27;cannot be empty&#x27;</span>) <span class="hljs-keyword">if</span> !<span class="hljs-type">name</span> || <span class="hljs-type">name</span>.empty?

    validates_presence [:title, :site]
    validates_unique :<span class="hljs-type">name</span>
    validates_format /\Ahttps?:\/\//, :website, :message=&gt;<span class="hljs-string">&#x27;is not a valid URL&#x27;</span>
    validates_includes %w(a b c), :<span class="hljs-keyword">type</span>
    validates_integer :rating
    validates_numeric :number
    validates_type String, [:title, :description]

    validates_integer :rating  <span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span>?

    # <span class="hljs-keyword">options</span>: :message =&gt;, :allow_nil =&gt;, :allow_blank =&gt;,
    #          :allow_missing =&gt;,

    validates_exact_length <span class="hljs-number">17</span>, :isbn
    validates_min_length <span class="hljs-number">3</span>, :<span class="hljs-type">name</span>
    validates_max_length <span class="hljs-number">100</span>, :<span class="hljs-type">name</span>
    validates_length_range <span class="hljs-number">3.</span><span class="hljs-number">.100</span>, :<span class="hljs-type">name</span>

    # Setter override
    def filename=(<span class="hljs-type">name</span>)
      @<span class="hljs-keyword">values</span>[:filename] = <span class="hljs-type">name</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

deal.errors
</code></pre>
<h3 id="model-stuff">Model stuff</h3>

<pre><code>deal = Deal[<span class="hljs-number">1</span>]
deal.changed_columns
deal.destroy  <span class="hljs-comment"># Calls hooks</span>
deal.<span class="hljs-built_in">delete</span>   <span class="hljs-comment"># No hooks</span>
deal.exists?
deal.<span class="hljs-built_in">new</span>?
deal.hash  <span class="hljs-comment"># Only uniques</span>
deal.<span class="hljs-built_in">keys</span>  <span class="hljs-comment">#=&gt; [:id, :name]</span>
deal.modified!
deal.modified?

deal.lock!
</code></pre>
<h3 id="callbacks">Callbacks</h3>

<pre><code><span class="hljs-keyword">before_create
</span>after_create

<span class="hljs-keyword">before_validation
</span>after_validation
<span class="hljs-keyword">before_save
</span><span class="hljs-keyword">before_update
</span>UPDATE QUERY
after_update
after_save

<span class="hljs-keyword">before_destroy
</span>DELETE QUERY
after_destroy
</code></pre>
<h3 id="schema">Schema</h3>

<pre><code><span class="hljs-keyword">class</span> <span class="hljs-symbol">Deal</span> &lt; <span class="hljs-symbol">Sequel::<span class="hljs-symbol">Model</span></span>
  <span class="hljs-symbol">set_schema</span> <span class="hljs-symbol">do</span>
    <span class="hljs-symbol">primary_key</span> :<span class="hljs-symbol">id</span>
    <span class="hljs-symbol">primary_key</span> [:<span class="hljs-symbol">id, :<span class="hljs-symbol">title</span></span>]
    <span class="hljs-symbol">String</span> :<span class="hljs-symbol">name, <span class="hljs-symbol">primary_key</span>: <span class="hljs-symbol">true</span></span>

    <span class="hljs-symbol">String</span>  :<span class="hljs-symbol">title</span>
    <span class="hljs-symbol">Numeric</span> :<span class="hljs-symbol">price</span>
    <span class="hljs-symbol">DateTime</span> :<span class="hljs-symbol">expires</span>

    <span class="hljs-symbol">unique</span> :<span class="hljs-symbol">whatever</span>
    <span class="hljs-symbol">check</span>(:<span class="hljs-symbol">price</span>) { num &gt; <span class="hljs-number">0</span> }

    foreign_key :artist_id
    String :artist_name, key: :id

    index :title
    index [:artist_id, :name]
    full_text_index :title

    # String, Integer, Fixnum, Bignum, Float, Numeric, BigDecimal,
    # Date, DateTime, Time, File, TrueClass, FalseClass
  end
end
</code></pre>
<h3 id="unrestrict-primary-key">Unrestrict primary key</h3>

<pre><code>Category.create <span class="hljs-keyword">id</span>: <span class="hljs-string">&#x27;travel&#x27;</span>   <span class="hljs-meta"># <span class="hljs-keyword">error</span></span>
Category.unrestrict_primary_key
Category.create <span class="hljs-keyword">id</span>: <span class="hljs-string">&#x27;travel&#x27;</span>   <span class="hljs-meta"># ok</span>
</code></pre>

</div>
</body>  
</html>