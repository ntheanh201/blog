<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Controllers cheatsheet</title>
  <link href="s/main.css" rel="stylesheet" />
  <script src="s/main.js"></script>
</head>

<body onload="start()">
  <div class="breadcrumbs"><a href="/">Home</a> / <a href="index.html">cheatsheets</a> / Controllers cheatsheet</div>
  <div class="edit">
      <a href="https://github.com/kjk/blog/blob/master/www/cheatsheets/devhints\rails-controllers.md" >edit</a>
  </div>
  <div class="toc">
<b>Main</b>: <a href="#common-stuff">Common stuff</a>, <a href="#special-hashes">Special hashes</a>, <a href="#respond_to">respond_to</a>, <a href="#default_url_options">default_url_options</a>, <a href="#filters">Filters</a>, <a href="#http-basic-authentication">HTTP basic authentication</a>, <a href="#request-response">Request/response</a>, <a href="#response">response</a>, <a href="#streaming">Streaming</a>, <a href="#references">References</a><br></div>


  <div id="start"></div>
  <div id="wrapped-content"></div>
<div id="content">
<h3 id="common-stuff">Common stuff</h3>

<pre><code><span class="hljs-attribute">redirect_to</span> root_url
redirect_to root_url, <span class="hljs-literal">notice</span>: <span class="hljs-string">&quot;Good.&quot;</span>
</code></pre>
<h3 id="special-hashes">Special hashes</h3>

<pre><code>session[<span class="hljs-symbol">:user_id</span>] = <span class="hljs-keyword">nil</span>

flash[<span class="hljs-symbol">:notice</span>] = <span class="hljs-string">&quot;Hello&quot;</span>    <span class="hljs-comment"># Gets flushed on next request</span>
flash.keep                  <span class="hljs-comment"># Persist flash values</span>
flash.now[<span class="hljs-symbol">:error</span>] = <span class="hljs-string">&quot;Boo&quot;</span>   <span class="hljs-comment"># Available on the same request</span>

cookies[<span class="hljs-symbol">:hello</span>] = <span class="hljs-string">&quot;Hi&quot;</span>

params[<span class="hljs-symbol">:page</span>]

<span class="hljs-comment"># params is a combination of:</span>
query_parameters
path_parameters
request_parameters
</code></pre>
<h3 id="respond_to">respond_to</h3>

<pre><code>respond_to <span class="hljs-keyword">do</span> |<span class="hljs-keyword">format</span>|
  <span class="hljs-keyword">format</span>.html
  <span class="hljs-keyword">format</span>.xml  { render <span class="hljs-type">xml</span>: @users }
  <span class="hljs-keyword">format</span>.json { render <span class="hljs-type">json</span>: @users }
  <span class="hljs-keyword">format</span>.js    # Will be executed <span class="hljs-keyword">by</span> the browser
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="default_url_options">default_url_options</h3>

<pre><code><span class="hljs-comment"># The options parameter is the hash passed in to &#x27;url_for&#x27;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">default_url_options</span><span class="hljs-params">(options)</span></span>

<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="filters">Filters</h3>

<pre><code><span class="hljs-comment"># Filter with callbacks</span>
before_filter <span class="hljs-symbol">:authenticate</span>
before_filter <span class="hljs-symbol">:authenticate</span>, <span class="hljs-symbol">except:</span> [<span class="hljs-symbol">:login</span>]
before_filter <span class="hljs-symbol">:authenticate</span>, <span class="hljs-symbol">only:</span> [<span class="hljs-symbol">:login</span>]
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authenticate</span></span>
  redirect_to login_url <span class="hljs-keyword">unless</span> controller.logged_in?
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># Filter with inline</span>
before_filter <span class="hljs-keyword">do</span> <span class="hljs-params">|controller|</span>
  redirect_to login_url <span class="hljs-keyword">unless</span> controller.logged_in?
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># Filter with external classes</span>
before_filter LoginFilter
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginFilter</span></span>
  def <span class="hljs-keyword">self</span>.filter(controller) ...; <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># Filter exceptions</span>
skip_before_filter <span class="hljs-symbol">:require_login</span>, <span class="hljs-symbol">only:</span> [<span class="hljs-symbol">:new</span>, <span class="hljs-symbol">:create</span>]

<span class="hljs-comment"># Before/after filters</span>
around_filter <span class="hljs-symbol">:wrap_in_transaction</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrap_in_transaction</span><span class="hljs-params">(&amp;blk)</span></span>
  ActiveRecord::Base.transaction { <span class="hljs-keyword">yield</span> }
<span class="hljs-keyword">end</span>
</code></pre>
<h3 id="http-basic-authentication">HTTP basic authentication</h3>

<pre><code>before_filter <span class="hljs-symbol">:authenticate</span>

<span class="hljs-comment"># Basic authentication:</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authenticate</span></span>
  authenticate_or_request_with_http_basic { |u, p|
    u == <span class="hljs-string">&quot;root&quot;</span> &amp;&amp; p == <span class="hljs-string">&quot;alpine&quot;</span>
  }
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># ...or digest (hashed) authentication:</span>
<span class="hljs-comment"># uses the ha1 hash (username:realm:password)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authenticate_by_digest</span></span>
  realm = <span class="hljs-string">&quot;Secret3000&quot;</span>
  users = {
    <span class="hljs-string">&quot;rsc&quot;</span> =&gt; Digest::MD5.hexdigest(<span class="hljs-string">&quot;rsc:<span class="hljs-subst">#{realm}</span>:passwordhere&quot;</span>)
  }

  authenticate_or_request_with_http_digest(realm) { |user|
    users[user]
  }
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># For integration tests</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_access</span></span>
  auth = ActionController::HttpAuthentication::Basic.encode_credentials(user, pass)
  get <span class="hljs-string">&quot;/notes/1.xml&quot;</span>, <span class="hljs-keyword">nil</span>, <span class="hljs-string">&#x27;HTTP_AUTHORIZATION&#x27;</span> =&gt; auth
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># Token auth</span>
is_logged_in = authenticate_with_http_token <span class="hljs-keyword">do</span> |token, options|
  token == our_secret_token
<span class="hljs-keyword">end</span>

request_http_token_authentication  <span class="hljs-keyword">unless</span> is_logged_in
</code></pre>
<h3 id="request-response">Request/response</h3>

<pre><code>request.host            <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;www.example.com&quot;</span></span>
request.domain          <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;www.example.com&quot;</span></span>
request.domain(n=<span class="hljs-number">2</span>)     <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;example.com&quot;</span></span>
request.port            <span class="hljs-meta">#=&gt; 80</span>
request.protocol        <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;http://&quot;</span></span>
request.query_string    <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;q=duck+tales&quot;</span></span>
request.url             <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;http://www.example.com/search?q=duck+tales&quot;</span></span>
request.fullpath        <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;/search?q=duck+tales&quot;</span></span>

request.headers         <span class="hljs-meta"># Returns a hash</span>

request.format          <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;text/html&quot;</span></span>
request.remote_ip       <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;203.167.220.220&quot;</span></span>
request.<span class="hljs-keyword">local</span>?          <span class="hljs-meta">#=&gt; true (if localhost/127.0.0.1)</span>

request.xhr?

request.method          <span class="hljs-meta">#=&gt; <span class="hljs-string">&quot;POST&quot;</span></span>
request.method_symbol   <span class="hljs-meta">#=&gt; :post</span>
request.get?
request.post?
request.put?
request.delete?
request.head?
</code></pre>
<h3 id="response">response</h3>

<pre><code>response.body
response.status         <span class="hljs-comment">#=&gt; 404</span>
response.<span class="hljs-keyword">location</span>       <span class="hljs-title"># Redirect</span> <span class="hljs-keyword">location</span>
<span class="hljs-title">response</span>.content_type
response.charset
response.headers

response.headers[<span class="hljs-string">&quot;Content-Type&quot;</span>] = <span class="hljs-string">&quot;application/pdf&quot;</span>
</code></pre>
<h3 id="streaming">Streaming</h3>

<pre><code>send_data pdfdata, filename: <span class="hljs-string">&quot;foo.pdf&quot;</span>, <span class="hljs-keyword">type</span>: <span class="hljs-string">&quot;application/pdf&quot;</span>
send_file Rails.root.<span class="hljs-keyword">join</span>(<span class="hljs-string">&#x27;public&#x27;</span>,<span class="hljs-string">&#x27;filename.txt&#x27;</span>) <span class="hljs-meta">[</span>filename: <span class="hljs-string">&#x27;..&#x27;</span>, <span class="hljs-keyword">type</span>: <span class="hljs-string">&#x27;..&#x27;</span><span class="hljs-meta">]</span>
</code></pre>
<h3 id="references">References</h3>

<ul>
<li><a href="http://guides.rubyonrails.org/action_controller_overview.html">Guide</a></li>
<li><a href="http://api.rubyonrails.org/classes/ActionController/HttpAuthentication/Basic.html">HttpAuthentication::Basic</a></li>
<li><a href="http://api.rubyonrails.org/classes/ActionController/HttpAuthentication/Token.html">HttpAuthentication::Token</a></li>
</ul>

</div>
</body>  
</html>