<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>{{.Title}} cheatsheet</title>
  <link href="s/cheatsheet.css" rel="stylesheet" />
  <script src="//unpkg.com/alpinejs" defer></script>
  <script src="s/cheatsheet.js"></script>
  <script>
    // [[text, text.toLowerCase(), id], ...]
    let searchIndex = [];

    function isHdrEl(el) {
      return el && ["h1", "h2", "h3", "h4"].includes(el.localName);
    }

    function isSiblingHeader(el) {
      const nextEl = el.nextElementSibling;
      return !nextEl || isHdrEl(nextEl);
    }

    function buildSearchIndex() {
      console.log("buildSearchIndex");
      const parent = elById("#content");
      for (const el of parent.children) {
        if (!isHdrEl(el)) {
          continue;
        }
        if (isSiblingHeader(el)) {
          //console.log(`skipping ${el.textContent}`);
          continue;
        }
        const txt = el.textContent;
        const id = el.id;
        searchIndex.push([txt, txt.toLowerCase(), id]);
        //console.log(`${txt} #${id}`);
      }
    }

    function doSearch(s) {
      s = s.toLowerCase();
      //console.log("search:", s);
      let filtered = [];
      for (const el of searchIndex) {
        if (el[1].includes(s)) {
          filtered.push(el);
        }
      }
    }

    function updateLocationHash(divId) {
      if (true) {
        window.location.hash = divId;
        return;
      }
      let h = window.location.hash;
      if (len(h) == 0) {
        h = divId;
      } else {
        h = divId + ";" + h.substr(1);
      }
      window.location.hash = h;
    }

    function bringToFrontDiv(hdrId) {
      // remove "first" class from the element that currently has it
      let els = document.getElementsByClassName("first");
      for (let el of els) {
        el.classList.remove("first");
      }

      const divId = hdrId + "-wrap";
      let el = elById(divId);
      el.classList.add("first");
      const startEl = elById("#start");
      el.remove();
      startEl.after(el);

      el = elById(hdrId)
      const fullName = el.getAttribute("data-name");
      if (fullName && fullName !== el.textContent) {
        el.textContent = fullName;
      }
      el.classList.add("flash");
      // TODO: doesn't work well because scrolls the content badly
      //updateLocationHash(divId);
    }

    function bringToFront(target) {
      const hdrId = target.getAttribute("href");
      bringToFrontDiv(hdrId);
    }

    function onClick(ev) {
      ev.preventDefault();
      bringToFront(ev.target);
      window.scrollTo(0, 0);
    }

    function hookClick() {
      const els = document.getElementsByTagName("a");
      const n = els.length;
      for (let i = 0; i < n; i++) {
        const el = els.item(i);
        const href = el.getAttribute("href");
        if (!href) {
          continue;
        }
        if (href[0] == "#") {
          el.onclick = onClick;
        } else if (href.startsWith("http")) {
          // make all external links open in new tab
          el.setAttribute("target", "_blank");
        }
      }
    }

    function appendBreadcrumb(s1, s2) {
      if (!s1) {
        return s2;
      }
      return s1 + " / " + s2;
    }

    // for nested headers we want the name be "File manipulation / Reading"
    // instead of just "Reading".
    // we build those once on h3 / h4 elements and store as "data-name" attribute
    function buildHeaderFullNames() {
      let currH1 = "";
      let currH2 = "";
      let currH3 = "";
      const parent = elById("#content");
      for (const el of parent.children) {
        const tag = el.localName;
        if (tag == "h1") {
          currH1 = el.textContent;
          continue;
        }
        if (tag === "h2") {
          currH2 = appendBreadcrumb(currH1, el.textContent);
          el.setAttribute("data-name", currH2);
          continue;
        }
        if (tag === "h3") {
          currH3 = appendBreadcrumb(currH2, el.textContent);
          el.setAttribute("data-name", currH3);
          continue;
        }
        if (tag === "h4") {
          const currH4 = appendBreadcrumb(currH3, el.textContent);
          el.setAttribute("data-name", currH4);
          continue;
        }
      }
    }

    // for every h2 in #content, wraps it and it's siblings (until next h2)
    // inside div and appends that div to #start
    function groupHeaderElements() {
      const parent = elById("#content");
      const groups = [];
      let curr = [];
      for (const el of parent.children) {
        if (isHdrEl(el)) {
          if (curr.length > 0) {
            groups.push(curr);
          }
          curr = [el];
        } else {
          curr.push(el);
        }
      }
      if (curr.length > 0) {
        groups.push(curr);
      }

      for (const group of groups) {
        const div = document.createElement("div");
        div.id = group[0].id + "-wrap";
        div.className = "dvwrap";

        for (const el of group) {
          div.appendChild(el);
        }

        const parent = elById("#wrapped-content");
        parent.appendChild(div);
      }
    }

    async function start() {
      // those 2 must call before groupHeaderElements()
      buildSearchIndex();
      buildHeaderFullNames();

      groupHeaderElements();
      hookClick();
      function showIntro() {
        for (const id of ["intro", "basics"]) {
          const el = document.getElementById(id);
          if (el) {
            bringToFrontDiv(id);
            return;
          }
        }
      }
      showIntro();
      document.addEventListener('keydown', (event) => {
        if (event.key == '/') {
          const el = document.getElementById("cs-search-input");
          el.value = "";
          el.focus();
          event.preventDefault();
        }
      });
    }
  </script>
  <style>
    h1 {
      font-size: 1.7em;
    }

    .topnav {
      margin: 0.5em 0;
      padding: 0 4px;
    }
  </style>
</head>

<body onload="start()">
  <div class="flex flex-row align-center topnav">
    <a href="/">Home</a>
    <div>&nbsp;/&nbsp;</div>
    <a href="index.html">cheatsheets</a>
    <div>&nbsp;/&nbsp;{{.Title}} cheatsheet</div>
    <div class="flex-grow"></div>
    <div x-data="{ search: '' }" x-init="$watch('search', val => { doSearch(val);})">
      <input x-model="search" @keyup.escape="search=''" id="cs-search-input" type="text" placeholder="'/' to search"
        style="width: 32em;">
    </div>
    <div class="flex-grow"></div>
    <a href="https://github.com/kjk/blog/blob/master/cheatsheets/{{.MdFileName}}">edit</a>
  </div>

  {{.InnerHTML}}

</body>

</html>