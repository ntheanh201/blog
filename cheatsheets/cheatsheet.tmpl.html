<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>{{title}} cheatsheet</title>
  <link href="s/cheatsheet.css" rel="stylesheet" />
  <script src="//unpkg.com/alpinejs" defer></script>
  <script src="s/cheatsheet.js"></script>
  <script>
    // [[text, text.toLowerCase(), id], ...]
    let searchIndex = [];
    let gSearch = null;

    function isHdrEl(el) {
      return el && ["h1", "h2", "h3", "h4"].includes(el.localName);
    }

    function buildSearchIndex() {
      console.log("buildSearchIndex");
      const parent = elById("#content");
      for (const el of parent.children) {
        if (!isHdrEl(el)) {
          continue;
        }
        if (isSiblingHeader(el)) {
          //console.log(`skipping ${el.textContent}`);
          continue;
        }
        const txt = el.textContent;
        const id = el.id;
        searchIndex.push([txt, txt.toLowerCase(), id]);
        //console.log(`${txt} #${id}`);
      }
    }
    function isSiblingHeader(el) {
      const nextEl = el.nextElementSibling;
      return !nextEl || isHdrEl(nextEl);
    }

    function updateLocationHash(divId) {
      if (true) {
        window.location.hash = divId;
        return;
      }
      let h = window.location.hash;
      if (len(h) == 0) {
        h = divId;
      } else {
        h = divId + ";" + h.substr(1);
      }
      window.location.hash = h;
    }

    function bringToFrontDiv(hdrId) {
      // remove "first" class from the element that currently has it
      let els = document.getElementsByClassName("first");
      for (let el of els) {
        el.classList.remove("first");
      }

      const divId = hdrId + "-wrap";
      let el = elById(divId);
      el.classList.add("first");
      const startEl = elById("#start");
      el.remove();
      startEl.after(el);

      el = elById(hdrId)
      const fullName = el.getAttribute("data-name");
      if (fullName && fullName !== el.textContent) {
        el.textContent = fullName;
      }
      el.classList.add("flash");
      // TODO: doesn't work well because scrolls the content badly
      //updateLocationHash(divId);
    }

    function onLinkClick(ev) {
      ev.preventDefault();
      const hdrId = ev.target.getAttribute("href");
      bringToFrontDiv(hdrId);
      window.scrollTo(0, 0);
    }

    function searchItemClicked(result) {
      const toSelectID = result[2];
      console.log(`search item clicked: '${toSelectID}'`)
      //ev.preventDefault();
      bringToFrontDiv(toSelectID);
      window.scrollTo(0, 0);
      gSearch.show = false;
      gSearch.results = [];
    }

    function hookClick() {
      const els = document.getElementsByTagName("a");
      const n = els.length;
      for (let i = 0; i < n; i++) {
        const el = els.item(i);
        const href = el.getAttribute("href");
        if (!href) {
          continue;
        }
        if (href[0] == "#") {
          el.onclick = onLinkClick;
        } else if (href.startsWith("http")) {
          // make all external links open in new tab
          el.setAttribute("target", "_blank");
        }
      }
    }

    function appendBreadcrumb(s1, s2) {
      if (!s1) {
        return s2;
      }
      return s1 + " / " + s2;
    }

    // for nested headers we want the name be "File manipulation / Reading"
    // instead of just "Reading".
    // we build those once on h3 / h4 elements and store as "data-name" attribute
    function buildHeaderFullNames() {
      let currH1 = "";
      let currH2 = "";
      let currH3 = "";
      const parent = elById("#content");
      for (const el of parent.children) {
        const tag = el.localName;
        if (tag == "h1") {
          currH1 = el.textContent;
          continue;
        }
        if (tag === "h2") {
          currH2 = appendBreadcrumb(currH1, el.textContent);
          el.setAttribute("data-name", currH2);
          continue;
        }
        if (tag === "h3") {
          currH3 = appendBreadcrumb(currH2, el.textContent);
          el.setAttribute("data-name", currH3);
          continue;
        }
        if (tag === "h4") {
          const currH4 = appendBreadcrumb(currH3, el.textContent);
          el.setAttribute("data-name", currH4);
          continue;
        }
      }
    }

    // for every h2 in #content, wraps it and it's siblings (until next h2)
    // inside div and appends that div to #start
    function groupHeaderElements() {
      const parent = elById("#content");
      const groups = [];
      let curr = [];
      for (const el of parent.children) {
        if (isHdrEl(el)) {
          if (curr.length > 0) {
            groups.push(curr);
          }
          curr = [el];
        } else {
          curr.push(el);
        }
      }
      if (curr.length > 0) {
        groups.push(curr);
      }

      for (const group of groups) {
        const div = document.createElement("div");
        div.id = group[0].id + "-wrap";
        div.className = "dvwrap box";

        for (const el of group) {
          div.appendChild(el);
        }

        const parent = elById("#wrapped-content");
        parent.appendChild(div);
      }
    }

    async function start() {
      // must call before groupHeaderElements()
      buildHeaderFullNames();
      buildSearchIndex();

      groupHeaderElements();
      hookClick();
      function showIntro() {
        for (const id of ["intro", "basics"]) {
          const el = document.getElementById(id);
          if (el) {
            bringToFrontDiv(id);
            return;
          }
        }
      }
      showIntro();
      document.addEventListener('keydown', (event) => {
        if (event.key == '/') {
          event.preventDefault();
          const el = document.getElementById("cs-search-input");
          el.value = "";
          el.focus();
          if (gSearch !== null) {
            gSearch.results = searchIndex;
            gSearch.show = true;
          }
        }
      });
    }

    function doSearch(search) {
      console.log("search:", search);
      let term = search.term.toLowerCase();
      let results = [];
      for (const el of searchIndex) {
        if (el[1].includes(term)) {
          results.push(el);
        }
      }
      search.results = results;
      search.resultsCount = len(results);
      search.selectedIdx = -1;
      console.log(`results: ${len(results)}`);
    }
  </script>
  <style>
    h1 {
      font-size: 1.7em;
    }

    .topnav {
      margin: 0.5em 0;
      padding: 0 4px;
    }

    .search-results-wrap {
      z-index: 19;
      /* bigger than toc */
      top: 2rem;

      width: 74vw;
      left: 13vw;
      right: 13vw;

      max-height: 40vh;
      overflow-y: scroll;
      overflow-x: hidden;
      font-size: 90%;
      min-height: 4rem;
      position: absolute;
    }

    /* search item */
    .si {
      padding-right: 0.5rem;
    }

    .si:hover {
      background-color: #fafafa;
      cursor: pointer;
    }
  </style>
</head>

<body onload="start()">
  <div class="flex flex-row align-center topnav">
    <a href="/">Home</a>
    <div>&nbsp;/&nbsp;</div>
    <a href="index.html">cheatsheets</a>
    <div>&nbsp;/&nbsp;{{title}} cheatsheet</div>
    <div class="flex-grow"></div>
    <div x-cloak class="relative" x-data="{ search: {
      term: '',
      results: [],
      resultsCount: 0,
      selectedIdx: -1,
      show: false
     } }" x-init="gSearch = search; $watch('search.term', val => { doSearch(search) })">
      <input x-model="search.term" @keyup.escape="search.term=''; search.show=false" id="cs-search-input" type="text"
        placeholder="'/' to search" class="relative" style="width: 32em;">
      <div x-show="search.show" class="overlay">
        <div class="box p-0 bg-white search-results-wrap">
          <template x-for="result in search.results">
            <div class="si" x-on:click.prevent="searchItemClicked(result)" x-html="result[0]"></div>
          </template>
        </div>
      </div>
    </div>
    <div class="flex-grow"></div>
    <a href="https://github.com/kjk/blog/blob/master/cheatsheets/{{mdFileName}}">edit</a>
  </div>

  <div class="toc box">
    {{#each toc}}
    {{#if children}}
    <b>{{content}}:</b>
    {{#each children}}{{#if @index}}, {{/if}}<a href="#{{this.ID}}">{{this.content}}</a>{{/each}} <br>
    {{else}}
    <a href="{{id}}">{{content}}</a><br>
    {{/if}}
    {{/each}}
  </div>

  <div id="start"></div>
  <div id="wrapped-content"></div>

  <div id="content">

    {{{content}}}

  </div>
</body>

</html>